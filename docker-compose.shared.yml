version: '3.8'

# ==========================================
# APOLO DOTA 2 BOT - VPS SHARED INFRASTRUCTURE
# ==========================================
# Production deployment using SHARED PostgreSQL 16 + Redis 7
# VPS: zapclaudio.com (31.97.103.184)
# Network: proxy (external - managed by VPS, same as other projects)
# ==========================================

networks:
  proxy:
    external: true  # Uses existing VPS network (proxy - shared infrastructure)

services:
  # ==========================================
  # APOLO Discord Bot
  # ==========================================
  apolo-bot:
    image: ghcr.io/upgrade-near-me/apolo-dota2-disc-bot:latest
    container_name: apolo-bot
    restart: always
    
    networks:
      - proxy
    
    # Load environment variables from .env file (created by GitHub Actions)
    env_file:
      - .env
    
    # NO public ports (Discord bot doesn't need external access)
    # Metrics port exposed only internally for Prometheus
    expose:
      - "9100"
    
    # NOTE: postgres and redis are EXTERNAL containers (shared VPS infrastructure)
    # No depends_on needed - they're always running
    
    # Persistent logs
    volumes:
      - ./logs:/app/logs
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Security: read-only filesystem (except /tmp)
    read_only: true
    tmpfs:
      - /tmp
      - /app/.npm
    
    # Resource limits (Protection against memory leaks & CPU spikes)
    # CRITICAL: These limits ensure APOLO never impacts other VPS projects
    deploy:
      resources:
        limits:
          cpus: '1.0'      # Max 1 CPU core (other projects protected)
          memory: 1G       # Max 1GB RAM (prevents OOM killing other containers)
        reservations:
          cpus: '0.5'      # Guaranteed 0.5 core
          memory: 512M     # Guaranteed 512MB

# ==========================================
# NOTES:
# ==========================================
# 1. PostgreSQL 16 and Redis 7 are EXTERNAL containers (managed by VPS)
# 2. Network "zapclaudio-network" is EXTERNAL (shared with other projects)
# 3. Database "apolo_dota2" must be created manually in PostgreSQL
# 4. Redis namespace "apolo:*" ensures cache isolation
# 5. No ports exposed publicly (Discord bot uses Gateway WebSocket)
# 6. Metrics on port 9100 are internal (Prometheus scraping)
# 7. Logs are persisted to ./logs directory
# 8. Health check on /health endpoint (9100)
# 9. Deploy automatically via GitHub Actions on push to main
# 10. Zero downtime for other VPS projects during APOLO updates
