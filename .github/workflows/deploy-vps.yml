name: Deploy to VPS (Shared Infrastructure)

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# Secrets required (configure in repository settings):
# - GHCR_TOKEN: GitHub Container Registry token
# - VPS_HOST: VPS IP address
# - VPS_USER: VPS SSH user
# - VPS_SSH_KEY: Private SSH key
# - DISCORD_TOKEN: Discord bot token
# - DISCORD_CLIENT_ID: Discord application ID
# - DISCORD_GUILD_ID: Test guild ID (optional)
# - APOLO_DB_USER: Database user
# - APOLO_DB_PASSWORD: Database password
# - APOLO_DB_NAME: Database name
# - REDIS_PASSWORD: Redis password
# - STRATZ_API_TOKEN_1: Stratz API token
# - STRATZ_API_TOKEN_2: Stratz API token (optional)
# - STRATZ_API_TOKEN_3: Stratz API token (optional)
# - STEAM_API_KEY: Steam Web API key
# - GEMINI_API_KEY_1: Gemini API key
# - GEMINI_API_KEY_2: Gemini API key (optional)
# - GEMINI_API_KEY_3: Gemini API key (optional)

jobs:
  # ==========================================
  # JOB 1: BUILD & PUSH DOCKER IMAGE
  # ==========================================
  build-and-push:
    name: Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}
      
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-
            type=ref,event=branch
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ==========================================
  # JOB 2: DEPLOY TO VPS
  # ==========================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build-and-push
    if: always() && needs.build-and-push.result == 'success'-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Create .env file for VPS
        run: |
          cat > .env.vps << EOF
          # Discord Configuration
          DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
          DISCORD_CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}
          DISCORD_GUILD_ID=${{ secrets.DISCORD_GUILD_ID }}
          
          # Database - Shared PostgreSQL 16
          APOLO_DB_USER=${{ secrets.APOLO_DB_USER }}
          APOLO_DB_PASSWORD=${{ secrets.APOLO_DB_PASSWORD }}
          APOLO_DB_NAME=${{ secrets.APOLO_DB_NAME }}
          
          # Redis - Shared Redis 7
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          
          # API Keys - Stratz
          STRATZ_API_TOKEN_1=${{ secrets.STRATZ_API_TOKEN_1 }}
          STRATZ_API_TOKEN_2=${{ secrets.STRATZ_API_TOKEN_2 }}
          STRATZ_API_TOKEN_3=${{ secrets.STRATZ_API_TOKEN_3 }}
          
          # Steam Web API
          STEAM_API_KEY=${{ secrets.STEAM_API_KEY }}
          
          # Google Gemini AI
          GEMINI_API_KEY_1=${{ secrets.GEMINI_API_KEY_1 }}
          GEMINI_API_KEY_2=${{ secrets.GEMINI_API_KEY_2 }}
          GEMINI_API_KEY_3=${{ secrets.GEMINI_API_KEY_3 }}
          
          # Node Environment
          NODE_ENV=production
          LOG_LEVEL=info
          EOF
      
      - name: Copy files to VPS
        run: |
          scp -i ~/.ssh/id_ed25519 docker-compose.shared.yml ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/root/apolo/docker-compose.yml
          scp -i ~/.ssh/id_ed25519 .env.vps ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/root/apolo/.env
      
      - name: Deploy on VPS
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            cd /root/apolo
            
            # Pull latest image
            docker pull ghcr.io/${{ github.repository }}:latest
            
            # Stop old container
            docker-compose down
            
            # Start new container
            docker-compose up -d
            
            # Wait for health check
            echo "Waiting for bot to be healthy..."
            sleep 30
            
            # Check status
            docker ps | grep apolo-bot
            docker logs --tail=20 apolo-bot
          ENDSSH
      
      - name: Run database migrations
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            cd /root/apolo
            docker exec apolo-bot npx tsx src/database/migrate.ts
          ENDSSH
      
      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            cd /root/apolo
            
            # Check container health
            docker inspect apolo-bot --format='{{.State.Health.Status}}'
            
            # Check logs for errors
            docker logs --tail=50 apolo-bot | grep -i error || echo "No errors found"
            
            # Test health endpoint
            docker exec apolo-bot curl -f http://localhost:9100/health
          ENDSSH
      
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519
          rm -f .env.vps
      
      - name: Deployment summary
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ðŸ¤– Bot: APOLO Dota 2"
          echo "ðŸ–¥ï¸  VPS: ${{ secrets.VPS_HOST }}"
          echo "ðŸ³ Image: ghcr.io/${{ github.repository }}:latest"
          echo "ðŸ“Š Metrics: http://${{ secrets.VPS_HOST }}:9100/metrics (internal)"
