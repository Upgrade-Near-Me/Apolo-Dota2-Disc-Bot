name: Deploy to VPS (Shared Infrastructure)

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# Secrets required (configure in repository settings):
# - GHCR_TOKEN: GitHub Container Registry token
# - VPS_HOST: VPS IP address
# - VPS_USER: VPS SSH user
# - VPS_SSH_KEY: Private SSH key
# - DISCORD_TOKEN: Discord bot token
# - DISCORD_CLIENT_ID: Discord application ID
# - DISCORD_GUILD_ID: Test guild ID (optional)
# - APOLO_DB_USER: Database user
# - APOLO_DB_PASSWORD: Database password
# - APOLO_DB_NAME: Database name
# - REDIS_PASSWORD: Redis password
# - STRATZ_API_TOKEN_1: Stratz API token
# - STRATZ_API_TOKEN_2: Stratz API token (optional)
# - STRATZ_API_TOKEN_3: Stratz API token (optional)
# - STEAM_API_KEY: Steam Web API key
# - GEMINI_API_KEY_1: Gemini API key
# - GEMINI_API_KEY_2: Gemini API key (optional)
# - GEMINI_API_KEY_3: Gemini API key (optional)

jobs:
  # ==========================================
  # JOB 1: BUILD & PUSH DOCKER IMAGE
  # ==========================================
  build-and-push:
    name: Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}
      
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-
            type=ref,event=branch
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ==========================================
  # JOB 2: DEPLOY TO VPS
  # ==========================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Prepare VPS environment and copy files
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          script: |
            export PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            mkdir -p /opt/apolo-bot
            cd /opt/apolo-bot
            
            # Create .env from environment
            cat > .env << 'ENV_EOF'
            # Discord Configuration
            DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
            DISCORD_CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}
            DISCORD_GUILD_ID=${{ secrets.DISCORD_GUILD_ID }}
            
            # Database Configuration
            APOLO_DB_USER=${{ secrets.APOLO_DB_USER }}
            APOLO_DB_PASSWORD=${{ secrets.APOLO_DB_PASSWORD }}
            APOLO_DB_NAME=${{ secrets.APOLO_DB_NAME }}
            DATABASE_URL=postgresql://${{ secrets.APOLO_DB_USER }}:${{ secrets.APOLO_DB_PASSWORD }}@postgres:5432/${{ secrets.APOLO_DB_NAME }}
            
            # Redis Configuration
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            REDIS_URL=redis://:${{ secrets.REDIS_PASSWORD }}@redis:6379/0
            REDIS_PREFIX=apolo
            
            # API Keys
            STRATZ_API_TOKEN_1=${{ secrets.STRATZ_API_TOKEN_1 }}
            STEAM_API_KEY=${{ secrets.STEAM_API_KEY }}
            GEMINI_API_KEY_1=${{ secrets.GEMINI_API_KEY_1 }}
            
            # Environment
            NODE_ENV=production
            LOG_LEVEL=info
            METRICS_PORT=9100
            ENV_EOF
            
            # Create docker-compose.yml with dedicated PostgreSQL and Redis
            cat > docker-compose.yml << 'COMPOSE_EOF'
            version: '3.8'
            
            networks:
              proxy:
                external: true
              internal:
                driver: bridge
            
            services:
              apolo-bot:
                image: ghcr.io/${{ github.repository }}:latest
                container_name: apolo-bot
                restart: always
                
                networks:
                  - proxy
                  - internal
                
                env_file:
                  - .env
                
                expose:
                  - "9100"
                
                depends_on:
                  postgres:
                    condition: service_healthy
                  redis:
                    condition: service_started
                
                deploy:
                  resources:
                    limits:
                      cpus: '1.0'
                      memory: 1G
                    reservations:
                      cpus: '0.5'
                      memory: 512M
                
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:9100/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
              
              postgres:
                image: postgres:16-alpine
                container_name: apolo-postgres
                restart: always
                
                networks:
                  - internal
                
                environment:
                  POSTGRES_USER: ${{ secrets.APOLO_DB_USER }}
                  POSTGRES_PASSWORD: ${{ secrets.APOLO_DB_PASSWORD }}
                  POSTGRES_DB: ${{ secrets.APOLO_DB_NAME }}
                
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U ${{ secrets.APOLO_DB_USER }}"]
                  interval: 10s
                  timeout: 5s
                  retries: 5
              
              redis:
                image: redis:7-alpine
                container_name: apolo-redis
                restart: always
                
                networks:
                  - internal
                
                command: redis-server --requirepass ${{ secrets.REDIS_PASSWORD }}
                
                volumes:
                  - redis_data:/data
                
                healthcheck:
                  test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
                  interval: 10s
                  timeout: 5s
                  retries: 5
            
            volumes:
              postgres_data:
              redis_data:
            COMPOSE_EOF
            
            # Create network if needed
            if ! docker network ls | grep -q proxy; then
              echo "Creating Docker network 'proxy'"
              docker network create proxy
            else
              echo "Docker network 'proxy' already exists"
            fi
            
            echo "‚úÖ VPS environment prepared successfully (dedicated PostgreSQL 16 + Redis 7)"
      
      - name: Deploy APOLO bot (with dedicated database and cache)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: false  # ‚Üê N√ÉO PARA EM ERRO - queremos ver TUDO
          command_timeout: 10m
          script: |
            cd /opt/apolo-bot
            
            echo "=========================================="
            echo "=== DIAGN√ìSTICO COMPLETO - DEBUG MODE ==="
            echo "=========================================="
            echo ""
            
            # ========================================
            # 1. RECURSOS DA VPS ANTES DO DEPLOY
            # ========================================
            echo "1Ô∏è‚É£ Recursos do Sistema ANTES:"
            echo ""
            free -h
            echo ""
            df -h /
            echo ""
            docker system df
            echo ""
            
            # ========================================
            # 2. LIMPAR CONTAINERS ANTIGOS
            # ========================================
            echo "2Ô∏è‚É£ Limpando containers antigos..."
            docker compose down || true
            docker ps -a | grep apolo || echo "Nenhum container APOLO antigo"
            echo ""
            
            # ========================================
            # 3. VERIFICAR ARQUIVOS DE CONFIG
            # ========================================
            echo "3Ô∏è‚É£ Verificando arquivos de configura√ß√£o:"
            echo ""
            echo "=== .env existe? ==="
            ls -lah .env || echo "‚ùå .env N√ÉO ENCONTRADO"
            echo ""
            echo "=== docker-compose.yml existe? ==="
            ls -lah docker-compose.yml || echo "‚ùå docker-compose.yml N√ÉO ENCONTRADO"
            echo ""
            echo "=== Primeiras 10 linhas do .env (sem senhas): ==="
            head -n 10 .env | sed 's/=.*/=***/' || echo "N√£o foi poss√≠vel ler .env"
            echo ""
            
            # ========================================
            # 4. PULL DA IMAGEM
            # ========================================
            echo "4Ô∏è‚É£ Fazendo pull da imagem Docker..."
            docker pull ghcr.io/${{ github.repository }}:latest || echo "‚ö†Ô∏è Pull falhou mas continuando..."
            echo ""
            
            # ========================================
            # 5. TENTAR SUBIR OS CONTAINERS (N√ÉO PARA EM ERRO)
            # ========================================
            echo "5Ô∏è‚É£ Tentando subir containers com docker-compose..."
            echo ""
            docker compose up -d || echo "‚ö†Ô∏è docker-compose up FALHOU - mas vamos ver os logs..."
            echo ""
            
            # ========================================
            # 6. ESTADO DE TODOS OS CONTAINERS
            # ========================================
            echo "6Ô∏è‚É£ Estado de TODOS os containers APOLO:"
            echo ""
            docker ps -a --filter "name=apolo" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo ""
            
            # ========================================
            # 7. LOGS COMPLETOS DE CADA CONTAINER
            # ========================================
            echo "7Ô∏è‚É£ LOGS COMPLETOS de cada container:"
            echo ""
            
            echo "=== LOGS: apolo-bot (√∫ltimas 100 linhas) ==="
            docker logs apolo-bot --tail=100 2>&1 || echo "Container apolo-bot n√£o existe ou n√£o tem logs"
            echo ""
            echo ""
            
            echo "=== LOGS: apolo-postgres (√∫ltimas 50 linhas) ==="
            docker logs apolo-postgres --tail=50 2>&1 || echo "Container apolo-postgres n√£o existe ou n√£o tem logs"
            echo ""
            echo ""
            
            echo "=== LOGS: apolo-redis (√∫ltimas 30 linhas) ==="
            docker logs apolo-redis --tail=30 2>&1 || echo "Container apolo-redis n√£o existe ou n√£o tem logs"
            echo ""
            echo ""
            
            # ========================================
            # 8. DOCKER INSPECT (detalhes t√©cnicos)
            # ========================================
            echo "8Ô∏è‚É£ Docker Inspect de cada container:"
            echo ""
            
            echo "=== APOLO-BOT Inspect ==="
            docker inspect apolo-bot --format='Status: {{.State.Status}} | Running: {{.State.Running}} | Exit Code: {{.State.ExitCode}} | Error: {{.State.Error}}' 2>&1 || echo "Container apolo-bot n√£o existe"
            echo ""
            
            echo "=== APOLO-POSTGRES Inspect ==="
            docker inspect apolo-postgres --format='Status: {{.State.Status}} | Running: {{.State.Running}} | Exit Code: {{.State.ExitCode}}' 2>&1 || echo "Container apolo-postgres n√£o existe"
            echo ""
            
            echo "=== APOLO-REDIS Inspect ==="
            docker inspect apolo-redis --format='Status: {{.State.Status}} | Running: {{.State.Running}} | Exit Code: {{.State.ExitCode}}' 2>&1 || echo "Container apolo-redis n√£o existe"
            echo ""
            
            # ========================================
            # 9. VERIFICAR NETWORKS
            # ========================================
            echo "9Ô∏è‚É£ Redes Docker:"
            echo ""
            docker network ls | grep -E "proxy|apolo" || echo "Nenhuma rede APOLO encontrada"
            echo ""
            
            # ========================================
            # 10. VERIFICAR VOLUMES
            # ========================================
            echo "üîü Volumes Docker:"
            echo ""
            docker volume ls | grep apolo || echo "Nenhum volume APOLO encontrado"
            echo ""
            
            # ========================================
            # 11. RECURSOS DA VPS DEPOIS DO DEPLOY
            # ========================================
            echo "1Ô∏è‚É£1Ô∏è‚É£ Recursos do Sistema DEPOIS:"
            echo ""
            free -h
            echo ""
            df -h /
            echo ""
            docker system df
            echo ""
            
            # ========================================
            # 12. TESTE DE CONECTIVIDADE (se containers rodando)
            # ========================================
            echo "1Ô∏è‚É£2Ô∏è‚É£ Testes de conectividade:"
            echo ""
            
            if docker ps | grep -q apolo-postgres; then
              echo "=== Testando conex√£o PostgreSQL ==="
              docker exec apolo-postgres pg_isready -U ${{ secrets.APOLO_DB_USER }} || echo "PostgreSQL n√£o est√° respondendo"
              echo ""
            fi
            
            if docker ps | grep -q apolo-redis; then
              echo "=== Testando conex√£o Redis ==="
              docker exec apolo-redis redis-cli -a ${{ secrets.REDIS_PASSWORD }} ping || echo "Redis n√£o est√° respondendo"
              echo ""
            fi
            
            if docker ps | grep -q apolo-bot; then
              echo "=== Testando bot (curl health) ==="
              docker exec apolo-bot curl -f http://localhost:9100/health 2>/dev/null && echo "‚úÖ Health OK" || echo "‚ö†Ô∏è Health endpoint n√£o responde"
              echo ""
            fi
            
            # ========================================
            # 13. RESUMO FINAL
            # ========================================
            echo "=========================================="
            echo "=== RESUMO DO DIAGN√ìSTICO ==="
            echo "=========================================="
            echo ""
            
            echo "Containers rodando (Up):"
            docker ps --filter "name=apolo" --format "{{.Names}}" || echo "Nenhum"
            echo ""
            
            echo "Containers parados (Exited):"
            docker ps -a --filter "name=apolo" --filter "status=exited" --format "{{.Names}} (Exit Code: {{.Status}})" || echo "Nenhum"
            echo ""
            
            echo "=========================================="
            echo "FIM DO DIAGN√ìSTICO"
            echo "=========================================="
      
      # ========================================
      # STEPS DESABILITADOS DURANTE DEBUG
      # ========================================
      # Descomente quando o diagn√≥stico mostrar que os containers est√£o rodando
      
      # - name: Run database migrations
      #   if: false  # Desabilitado para debug
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.VPS_HOST }}
      #     username: ${{ secrets.VPS_USER }}
      #     key: ${{ secrets.VPS_SSH_KEY }}
      #     script_stop: true
      #     script: |
      #       cd /opt/apolo-bot
      #       docker exec apolo-bot npx tsx src/database/migrate.ts
      #       docker exec apolo-bot npx tsx src/deploy-commands.ts
      
      # - name: Verify deployment
      #   if: false  # Desabilitado para debug
      
      - name: Debug Summary
        if: always()
        run: |
          echo "=========================================="
          echo "üîç DEBUG MODE - Workflow Complete"
          echo "=========================================="
          echo ""
          echo "üìã Verifique o output do step anterior para:"
          echo "   ‚Ä¢ Estado dos containers (Up/Exited)"
          echo "   ‚Ä¢ Logs completos de cada container"
          echo "   ‚Ä¢ Uso de recursos (RAM/Disco)"
          echo "   ‚Ä¢ Mensagens de erro espec√≠ficas"
          echo ""
          echo "üö® Se containers est√£o em 'Exited':"
          echo "   ‚Üí Procure por 'Exit Code' nos logs"
          echo "   ‚Üí Verifique vari√°veis de ambiente"
          echo "   ‚Üí Cheque uso de mem√≥ria (OOM?)"
          echo ""
          echo "=========================================="
