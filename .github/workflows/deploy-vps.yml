name: Deploy to VPS (Shared Infrastructure)

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# Secrets required (configure in repository settings):
# - GHCR_TOKEN: GitHub Container Registry token
# - VPS_HOST: VPS IP address
# - VPS_USER: VPS SSH user
# - VPS_SSH_KEY: Private SSH key
# - DISCORD_TOKEN: Discord bot token
# - DISCORD_CLIENT_ID: Discord application ID
# - DISCORD_GUILD_ID: Test guild ID (optional)
# - APOLO_DB_USER: Database user
# - APOLO_DB_PASSWORD: Database password
# - APOLO_DB_NAME: Database name
# - REDIS_PASSWORD: Redis password
# - STRATZ_API_TOKEN_1: Stratz API token
# - STRATZ_API_TOKEN_2: Stratz API token (optional)
# - STRATZ_API_TOKEN_3: Stratz API token (optional)
# - STEAM_API_KEY: Steam Web API key
# - GEMINI_API_KEY_1: Gemini API key
# - GEMINI_API_KEY_2: Gemini API key (optional)
# - GEMINI_API_KEY_3: Gemini API key (optional)

jobs:
  # ==========================================
  # JOB 1: BUILD & PUSH DOCKER IMAGE
  # ==========================================
  build-and-push:
    name: Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}
      
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-
            type=ref,event=branch
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ==========================================
  # JOB 2: DEPLOY TO VPS
  # ==========================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Prepare VPS environment and copy files
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          script: |
            export PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            mkdir -p /opt/apolo-bot
            cd /opt/apolo-bot
            
            # Create .env from environment
            cat > .env << 'ENV_EOF'
            # Discord Configuration
            DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}
            DISCORD_CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}
            DISCORD_GUILD_ID=${{ secrets.DISCORD_GUILD_ID }}
            
            # Database Configuration
            APOLO_DB_USER=${{ secrets.APOLO_DB_USER }}
            APOLO_DB_PASSWORD=${{ secrets.APOLO_DB_PASSWORD }}
            APOLO_DB_NAME=${{ secrets.APOLO_DB_NAME }}
            DATABASE_URL=postgresql://${{ secrets.APOLO_DB_USER }}:${{ secrets.APOLO_DB_PASSWORD }}@postgres:5432/${{ secrets.APOLO_DB_NAME }}
            
            # Redis Configuration
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            REDIS_URL=redis://:${{ secrets.REDIS_PASSWORD }}@redis:6379/0
            REDIS_PREFIX=apolo
            
            # API Keys
            STRATZ_API_TOKEN_1=${{ secrets.STRATZ_API_TOKEN_1 }}
            STEAM_API_KEY=${{ secrets.STEAM_API_KEY }}
            GEMINI_API_KEY_1=${{ secrets.GEMINI_API_KEY_1 }}
            
            # Environment
            NODE_ENV=production
            LOG_LEVEL=info
            METRICS_PORT=9100
            ENV_EOF
            
            # Create docker-compose.yml from shared config
            cat > docker-compose.yml << 'COMPOSE_EOF'
            version: '3.8'
            
            networks:
              proxy:
                external: true
            
            services:
              apolo-bot:
                image: ghcr.io/${{ github.repository }}:latest
                container_name: apolo-bot
                restart: always
                
                networks:
                  - proxy
                
                env_file:
                  - .env
                
                expose:
                  - "9100"
                
                depends_on:
                  - postgres
                  - redis
                
                deploy:
                  resources:
                    limits:
                      cpus: '1.0'
                      memory: 1G
                    reservations:
                      cpus: '0.5'
                      memory: 512M
                
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:9100/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
            COMPOSE_EOF
            
            # Create network if needed
            if ! docker network ls | grep -q proxy; then
              echo "Creating Docker network 'proxy'"
              docker network create proxy
            else
              echo "Docker network 'proxy' already exists"
            fi
            
            echo "‚úÖ VPS environment prepared successfully"
      
      - name: Verify infrastructure
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          script: |
            if ! docker ps | grep -q postgres; then
              echo "ERROR: PostgreSQL container not running"
              exit 1
            fi
            echo "‚úÖ PostgreSQL container is running"
            
            if ! docker ps | grep -q redis; then
              echo "ERROR: Redis container not running"
              exit 1
            fi
            echo "‚úÖ Redis container is running"
            
            echo "Creating database apolo_dota2 (if not exists)..."
            docker exec postgres psql -U postgres -tc "SELECT 1 FROM pg_database WHERE datname = 'apolo_dota2'" | grep -q 1 || \
              docker exec postgres psql -U postgres -c "CREATE DATABASE apolo_dota2;"
            echo "‚úÖ Database apolo_dota2 ready"
      
      - name: Deploy APOLO bot
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          command_timeout: 10m
          script: |
            cd /opt/apolo-bot
            
            echo "üì• Pulling latest APOLO image..."
            docker pull ghcr.io/${{ github.repository }}:latest
            
            echo "üõë Stopping old container..."
            docker compose down || true
            
            echo "üöÄ Starting new container..."
            docker compose up -d
            
            echo "‚è≥ Waiting for container to initialize (10s)..."
            sleep 10
            
            # ========================================
            # üîç VERIFICA√á√ÉO 1: Container est√° running?
            # ========================================
            echo ""
            echo "=== Container Status Check ==="
            if ! docker ps | grep -q apolo-bot; then
              echo "‚ùå ERROR: Container NOT running (crashed immediately)"
              echo ""
              echo "=== Container List (all) ==="
              docker ps -a | grep apolo-bot || true
              echo ""
              echo "=== FULL LOGS (last 100 lines) ==="
              docker logs apolo-bot --tail=100 || true
              echo ""
              echo "=== Docker Inspect (exit code) ==="
              docker inspect apolo-bot --format='{{.State.Status}} - Exit Code: {{.State.ExitCode}}' || true
              exit 1
            fi
            
            echo "‚úÖ Container is running (initial check passed)"
            
            # ========================================
            # üîç VERIFICA√á√ÉO 2: Logs durante inicializa√ß√£o
            # ========================================
            echo ""
            echo "=== Recent Logs (first 10s) ==="
            docker logs apolo-bot --tail=30
            
            echo ""
            echo "‚è≥ Waiting for bot to fully initialize (30s more)..."
            sleep 30
            
            # ========================================
            # üîç VERIFICA√á√ÉO 3: Container ainda est√° vivo?
            # ========================================
            echo ""
            echo "=== Container Status After 40s Total ==="
            if ! docker ps | grep -q apolo-bot; then
              echo "‚ùå ERROR: Container CRASHED during initialization"
              echo ""
              echo "=== CRASH LOGS (last 150 lines) ==="
              docker logs apolo-bot --tail=150 || true
              echo ""
              echo "=== Docker Inspect ==="
              docker inspect apolo-bot --format='{{.State.Status}} - Exit Code: {{.State.ExitCode}} - Error: {{.State.Error}}' || true
              exit 1
            fi
            
            echo "‚úÖ Container survived initialization period"
            
            # ========================================
            # üîç VERIFICA√á√ÉO 4: Logs completos antes migra√ß√£o
            # ========================================
            echo ""
            echo "=== Full Logs Before Migration ==="
            docker logs apolo-bot --tail=50
            
            echo ""
            echo "‚úÖ Pre-migration checks complete"
      
      - name: Run database migrations
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          script: |
            cd /opt/apolo-bot
            
            # ========================================
            # üîç VERIFICA√á√ÉO FINAL: Container rodando?
            # ========================================
            echo "=== Final Container Check Before Migration ==="
            if ! docker ps | grep -q apolo-bot; then
              echo "‚ùå FATAL: Container NOT RUNNING before migration"
              echo ""
              echo "=== ALL LOGS ==="
              docker logs apolo-bot || true
              echo ""
              echo "=== Container State ==="
              docker ps -a | grep apolo-bot || true
              exit 1
            fi
            
            echo "‚úÖ Container confirmed running"
            echo ""
            
            echo "üóÑÔ∏è Running database migrations..."
            if ! docker exec apolo-bot npx tsx src/database/migrate.ts; then
              echo "‚ö†Ô∏è Migrations failed, checking logs..."
              docker logs apolo-bot --tail=100
              exit 1
            fi
            
            echo "üì° Deploying Discord commands..."
            if ! docker exec apolo-bot npx tsx src/deploy-commands.ts; then
              echo "‚ö†Ô∏è Command deployment failed, checking logs..."
              docker logs apolo-bot --tail=50
              exit 1
            fi
            
            echo "‚úÖ Migrations and commands deployed"
      
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: false
          script: |
            echo "=========================================="
            echo "=== APOLO Deployment Verification ==="
            echo "=========================================="
            echo ""
            
            echo "1. Container Status:"
            docker ps --filter "name=apolo-bot" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
            echo ""
            
            echo "2. Container Inspect (if running):"
            docker inspect apolo-bot --format='Status: {{.State.Status}} | Running: {{.State.Running}} | Uptime: {{.State.StartedAt}}' 2>/dev/null || echo "Container not found"
            echo ""
            
            echo "3. Recent Logs (last 30 lines):"
            docker logs apolo-bot --tail=30 2>&1 || echo "No logs available"
            echo ""
            
            echo "4. Health Check (port 9100):"
            docker exec apolo-bot curl -f http://localhost:9100/health 2>/dev/null && echo "‚úÖ Health endpoint responding" || echo "‚ö†Ô∏è No health response"
            echo ""
            
            echo "5. Network Connectivity:"
            docker exec apolo-bot ping -c 2 postgres 2>/dev/null && echo "‚úÖ PostgreSQL reachable" || echo "‚ö†Ô∏è PostgreSQL unreachable"
            docker exec apolo-bot ping -c 2 redis 2>/dev/null && echo "‚úÖ Redis reachable" || echo "‚ö†Ô∏è Redis unreachable"
            echo ""
            
            echo "=========================================="
            echo "‚úÖ Deployment verification complete"
            echo "=========================================="
            
            echo "‚úÖ Migrations and commands deployed"
      
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: false
          script: |
            echo "=========================================="
            echo "=== APOLO Deployment Verification ==="
            echo "=========================================="
            echo ""
            
            echo "1. Container Status:"
            docker ps --filter "name=apolo-bot" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo ""
            
            echo "2. Recent Logs (last 20 lines):"
            docker logs apolo-bot --tail=20
            echo ""
            
            echo "3. Health Check:"
            docker exec apolo-bot curl -f http://localhost:9100/health 2>/dev/null && echo "‚úÖ Healthy" || echo "‚ö†Ô∏è No response"
            echo ""
            
            echo "4. Database Connectivity:"
            docker exec apolo-bot npx tsx -e "import pool from './dist/database/index.js'; pool.query('SELECT 1').then(() => console.log('‚úÖ Connected')).catch(() => console.log('‚ùå Failed'))" || true
            echo ""
            
            echo "5. Other Services Status:"
            docker ps --format "table {{.Names}}\t{{.Status}}" | grep -E "postgres|redis|n8n" || echo "No other services visible"
            echo ""
            
            echo "=========================================="
            echo "‚úÖ Deployment verification complete"
            echo "=========================================="
      
      - name: Deployment summary
        if: success()
        run: |
          echo "=========================================="
          echo "‚úÖ DEPLOYMENT SUCCESSFUL"
          echo "=========================================="
          echo ""
          echo "ü§ñ Bot: APOLO Dota 2"
          echo "üñ•Ô∏è  VPS: ${{ secrets.VPS_HOST }}"
          echo "üìÅ Directory: /opt/apolo-bot"
          echo "üê≥ Image: ghcr.io/${{ github.repository }}:latest"
          echo "üîó Network: proxy (shared)"
          echo "üóÑÔ∏è  Database: apolo_dota2"
          echo "üíæ Redis: apolo:* namespace"
          echo ""
          echo "üöÄ Next Steps:"
          echo "   1. Test bot in Discord: /dashboard"
          echo "   2. Monitor logs: ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'docker logs -f apolo-bot'"
          echo "   3. Check metrics: http://${{ secrets.VPS_HOST }}:9100/metrics"
          echo ""
          echo "=========================================="
