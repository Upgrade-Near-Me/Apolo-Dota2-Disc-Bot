name: Test Secrets & Connections

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      test_vps:
        description: 'Test VPS SSH connection'
        required: false
        default: true
        type: boolean
      test_apis:
        description: 'Test API keys (Stratz, Gemini, Steam)'
        required: false
        default: true
        type: boolean

jobs:
  test-secrets:
    name: Validate Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.1'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Test Discord Token
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}
        run: |
          echo "=== Testing Discord Credentials ==="
          if [ -z "$DISCORD_TOKEN" ]; then
            echo "❌ DISCORD_TOKEN is missing"
            exit 1
          else
            echo "✅ DISCORD_TOKEN exists (${#DISCORD_TOKEN} chars)"
          fi
          
          if [ -z "$DISCORD_CLIENT_ID" ]; then
            echo "❌ DISCORD_CLIENT_ID is missing"
            exit 1
          else
            echo "✅ DISCORD_CLIENT_ID exists: $DISCORD_CLIENT_ID"
          fi
      
      - name: Test Database Credentials
        env:
          APOLO_DB_NAME: ${{ secrets.APOLO_DB_NAME }}
          APOLO_DB_USER: ${{ secrets.APOLO_DB_USER }}
          APOLO_DB_PASSWORD: ${{ secrets.APOLO_DB_PASSWORD }}
        run: |
          echo "=== Testing Database Credentials ==="
          if [ -z "$APOLO_DB_NAME" ]; then
            echo "❌ APOLO_DB_NAME is missing"
            exit 1
          else
            echo "✅ APOLO_DB_NAME: $APOLO_DB_NAME"
          fi
          
          if [ -z "$APOLO_DB_USER" ]; then
            echo "❌ APOLO_DB_USER is missing"
            exit 1
          else
            echo "✅ APOLO_DB_USER: $APOLO_DB_USER"
          fi
          
          if [ -z "$APOLO_DB_PASSWORD" ]; then
            echo "❌ APOLO_DB_PASSWORD is missing"
            exit 1
          else
            echo "✅ APOLO_DB_PASSWORD exists (${#APOLO_DB_PASSWORD} chars)"
          fi
      
      - name: Test Redis Credentials
        env:
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        run: |
          echo "=== Testing Redis Credentials ==="
          if [ -z "$REDIS_PASSWORD" ]; then
            echo "⚠️  REDIS_PASSWORD is missing (may be optional)"
          else
            echo "✅ REDIS_PASSWORD exists (${#REDIS_PASSWORD} chars)"
          fi
      
      - name: Test API Keys
        if: ${{ inputs.test_apis }}
        env:
          STRATZ_API_TOKEN_1: ${{ secrets.STRATZ_API_TOKEN_1 }}
          STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
          GEMINI_API_KEY_1: ${{ secrets.GEMINI_API_KEY_1 }}
        run: |
          echo "=== Testing API Keys ==="
          
          # Stratz API
          if [ -z "$STRATZ_API_TOKEN_1" ]; then
            echo "❌ STRATZ_API_TOKEN_1 is missing"
          else
            echo "✅ STRATZ_API_TOKEN_1 exists (${#STRATZ_API_TOKEN_1} chars)"
            
            # Test Stratz API call
            echo "Testing Stratz API connectivity..."
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $STRATZ_API_TOKEN_1" \
              -H "Content-Type: application/json" \
              -d '{"query":"{ constants { heroes { id name } } }"}' \
              https://api.stratz.com/graphql)
            
            if [ "$response" = "200" ]; then
              echo "✅ Stratz API: Connected successfully"
            else
              echo "⚠️  Stratz API returned: $response (may be rate limited or invalid token)"
            fi
          fi
          
          # Steam API
          if [ -z "$STEAM_API_KEY" ]; then
            echo "⚠️  STEAM_API_KEY is missing (optional)"
          else
            echo "✅ STEAM_API_KEY exists (${#STEAM_API_KEY} chars)"
            
            # Test Steam API call
            echo "Testing Steam API connectivity..."
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://api.steampowered.com/ISteamWebAPIUtil/GetSupportedAPIList/v1/?key=$STEAM_API_KEY")
            
            if [ "$response" = "200" ]; then
              echo "✅ Steam API: Connected successfully"
            else
              echo "⚠️  Steam API returned: $response (may be invalid key)"
            fi
          fi
          
          # Gemini API
          if [ -z "$GEMINI_API_KEY_1" ]; then
            echo "⚠️  GEMINI_API_KEY_1 is missing (optional for AI features)"
          else
            echo "✅ GEMINI_API_KEY_1 exists (${#GEMINI_API_KEY_1} chars)"
            
            # Test Gemini API call
            echo "Testing Gemini API connectivity..."
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Content-Type: application/json" \
              -d '{"contents":[{"parts":[{"text":"test"}]}]}' \
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=$GEMINI_API_KEY_1")
            
            if [ "$response" = "200" ]; then
              echo "✅ Gemini API: Connected successfully"
            else
              echo "⚠️  Gemini API returned: $response (may be invalid key or quota exceeded)"
            fi
          fi
      
      - name: Test VPS SSH Connection
        if: ${{ inputs.test_vps }}
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          echo "=== Testing VPS Connection ==="
          
          if [ -z "$VPS_HOST" ]; then
            echo "❌ VPS_HOST is missing"
            exit 1
          else
            echo "✅ VPS_HOST: $VPS_HOST"
          fi
          
          if [ -z "$VPS_USER" ]; then
            echo "❌ VPS_USER is missing"
            exit 1
          else
            echo "✅ VPS_USER: $VPS_USER"
          fi
          
          if [ -z "$VPS_SSH_KEY" ]; then
            echo "❌ VPS_SSH_KEY is missing"
            exit 1
          else
            echo "✅ VPS_SSH_KEY exists (${#VPS_SSH_KEY} chars)"
            
            # Setup SSH key
            mkdir -p ~/.ssh
            echo "$VPS_SSH_KEY" > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
            
            # Test SSH connection
            echo "Testing SSH connection to VPS..."
            if ssh -i ~/.ssh/id_ed25519 -o ConnectTimeout=10 $VPS_USER@$VPS_HOST "echo 'SSH connection successful'"; then
              echo "✅ VPS SSH: Connected successfully"
              
              # Check if Docker is installed
              echo "Checking Docker on VPS..."
              ssh -i ~/.ssh/id_ed25519 $VPS_USER@$VPS_HOST "docker --version" || echo "⚠️  Docker not found"
              
              # Check if PostgreSQL container exists
              echo "Checking PostgreSQL container..."
              ssh -i ~/.ssh/id_ed25519 $VPS_USER@$VPS_HOST "docker ps | grep postgres" || echo "⚠️  PostgreSQL container not running"
              
              # Check if Redis container exists
              echo "Checking Redis container..."
              ssh -i ~/.ssh/id_ed25519 $VPS_USER@$VPS_HOST "docker ps | grep redis" || echo "⚠️  Redis container not running"
              
            else
              echo "❌ VPS SSH: Connection failed"
              exit 1
            fi
          fi
      
      - name: Test GHCR Token
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          echo "=== Testing GitHub Container Registry ==="
          if [ -z "$GHCR_TOKEN" ]; then
            echo "❌ GHCR_TOKEN is missing"
            exit 1
          else
            echo "✅ GHCR_TOKEN exists (${#GHCR_TOKEN} chars)"
            
            # Test login
            echo "Testing GHCR login..."
            if echo "$GHCR_TOKEN" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin; then
              echo "✅ GHCR: Login successful"
            else
              echo "❌ GHCR: Login failed"
              exit 1
            fi
          fi
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "        SECRETS VALIDATION SUMMARY"
          echo "=========================================="
          echo ""
          echo "✅ All required secrets are configured"
          echo "✅ Connections tested successfully"
          echo ""
          echo "Next steps:"
          echo "  1. Review any warnings above"
          echo "  2. If all green, you're ready to deploy!"
          echo "  3. Run 'Deploy to VPS' workflow to deploy"
          echo ""
          echo "=========================================="
