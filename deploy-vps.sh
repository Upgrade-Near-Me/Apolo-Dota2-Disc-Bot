#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# APOLO DOTA 2 BOT - VPS DEPLOYMENT SCRIPT
# Hostinger Ubuntu 22.04+ 
# Execute tudo de uma vez!
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e  # Exit if any command fails

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ  ๐ APOLO DOTA 2 - VPS DEPLOYMENT INICIADO                โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 1: Update Sistema
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ฆ [1/10] Atualizando sistema..."
sudo apt update
sudo apt upgrade -y
sudo apt autoremove -y

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 2: Instalar Docker
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ณ [2/10] Instalando Docker..."
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker root

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 3: Instalar Docker Compose
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ฏ [3/10] Instalando Docker Compose..."
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 4: Verificar Docker
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "โ [4/10] Verificando Docker..."
docker --version
docker-compose --version

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 5: Clonar Repositรณrio
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ฅ [5/10] Clonando repositรณrio..."
cd /root
git clone https://github.com/Upgrade-Near-Me/Apolo-Dota2-Disc-Bot.git apolo
cd apolo

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 6: Copiar .env
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "โ๏ธ  [6/10] Configurando .env..."
cp .env.example .env
chmod 600 .env

echo ""
echo "โ๏ธ  ATENรรO: Edite o arquivo .env com seus tokens!"
echo "   nano /root/apolo/.env"
echo ""
echo "   Campos obrigatรณrios:"
echo "   - DISCORD_TOKEN"
echo "   - DISCORD_CLIENT_ID"
echo "   - DISCORD_GUILD_ID"
echo "   - STRATZ_API_TOKEN_1"
echo "   - DATABASE_PASSWORD"
echo "   - REDIS_PASSWORD"
echo "   - GEMINI_API_KEY_1"
echo "   - GRAFANA_ADMIN_PASSWORD"
echo ""
echo "   Salve com: Ctrl+X -> Y -> Enter"
echo ""
read -p "โ Pressione ENTER quando terminar de editar o .env..."

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 7: Construir e Iniciar Docker Compose
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐จ [7/10] Construindo containers Docker..."
docker-compose -f docker-compose.prod.yml up -d --build

echo ""
echo "โณ Aguardando 60 segundos para containers ficarem healthy..."
sleep 60

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 8: Verificar Status
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ [8/10] Status dos containers:"
docker-compose -f docker-compose.prod.yml ps

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 9: Rodar Migrations
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐๏ธ  [9/10] Executando migraรงรตes de banco de dados..."
docker-compose -f docker-compose.prod.yml exec -T bot npx tsx src/database/migrate.ts

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 10: Deploy Comandos Discord
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ค [10/10] Deployando comandos Discord..."
docker-compose -f docker-compose.prod.yml exec -T bot npx tsx src/deploy-commands.ts

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# FIM
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ  โ DEPLOYMENT COMPLETO!                                  โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ Acesso ao Grafana:"
echo "   URL: http://31.97.103.184:3000"
echo "   User: admin"
echo "   Pass: [sua senha do GRAFANA_ADMIN_PASSWORD]"
echo ""
echo "๐ค Bot Status:"
docker-compose -f docker-compose.prod.yml logs --tail=20 bot
echo ""
echo "๐ Comandos รบteis:"
echo "   Ver logs:      docker-compose -f docker-compose.prod.yml logs -f bot"
echo "   Parar:         docker-compose -f docker-compose.prod.yml down"
echo "   Reiniciar:     docker-compose -f docker-compose.prod.yml restart"
echo "   Status:        docker-compose -f docker-compose.prod.yml ps"
echo ""
echo "๐ Seu bot estรก rodando!"
